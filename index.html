<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è’è—ç®¡ç†</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<style>
:root{--bg:#0f0e0c;--surface:#1a1916;--surface2:#242220;--border:#333129;--accent:#c9a84c;--accent2:#e8c97a;--text:#f0ece0;--text2:#a09880;--danger:#c94c4c;--success:#4caf7d;}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:'Noto Serif TC',serif;min-height:100vh;padding-bottom:80px;}
.header{background:var(--surface);border-bottom:1px solid var(--border);padding:12px 20px;position:sticky;top:0;z-index:100;display:flex;align-items:center;justify-content:space-between;gap:10px;}
.header h1{font-size:17px;font-weight:900;color:var(--accent);letter-spacing:2px;flex-shrink:0;}
.header-right{display:flex;align-items:center;gap:8px;}
.header-stats{font-family:'Space Mono',monospace;font-size:10px;color:var(--text2);text-align:right;}
.header-stats span{color:var(--accent2);font-weight:700;}
.sync-dot{width:7px;height:7px;border-radius:50%;background:var(--success);flex-shrink:0;cursor:help;}
.sync-dot.syncing{background:var(--accent);animation:pulse .8s infinite;}
.sync-dot.error{background:var(--danger);}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.backup-btn{background:none;border:1px solid var(--border);color:var(--text2);padding:5px 10px;border-radius:16px;font-size:11px;font-family:'Space Mono',monospace;cursor:pointer;transition:all .2s;white-space:nowrap;}
.backup-btn:hover{border-color:var(--accent);color:var(--accent);}
.reminder-banner{background:rgba(201,168,76,.1);border:1px solid var(--accent);border-radius:10px;padding:13px 16px;margin:12px 20px;display:none;align-items:center;gap:12px;}
.reminder-banner p{flex:1;font-size:13px;color:var(--text);line-height:1.5;}
.remind-btn{flex-shrink:0;background:var(--accent);color:var(--bg);border:none;padding:8px 14px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;font-family:'Noto Serif TC',serif;}
.dismiss-btn{flex-shrink:0;background:none;border:1px solid var(--border);color:var(--text2);padding:8px 10px;border-radius:6px;font-size:12px;cursor:pointer;}
.summary{background:var(--surface2);border-bottom:1px solid var(--border);padding:12px 20px;display:flex;gap:20px;overflow-x:auto;scrollbar-width:none;}
.summary-item{flex-shrink:0;text-align:center;}
.summary-item .label{font-size:10px;color:var(--text2);letter-spacing:1px;text-transform:uppercase;}
.summary-item .value{font-family:'Space Mono',monospace;font-size:14px;font-weight:700;color:var(--accent2);}
.tabs{display:flex;padding:12px 20px 0;gap:8px;overflow-x:auto;scrollbar-width:none;border-bottom:1px solid var(--border);}
.tab{flex-shrink:0;padding:8px 16px;border-radius:6px 6px 0 0;border:1px solid transparent;background:none;color:var(--text2);font-family:'Noto Serif TC',serif;font-size:13px;cursor:pointer;transition:all .2s;border-bottom:none;}
.tab.active{background:var(--surface);border-color:var(--border);border-bottom-color:var(--surface);color:var(--accent);margin-bottom:-1px;}
.tab .count{display:inline-block;background:var(--border);color:var(--text2);font-family:'Space Mono',monospace;font-size:10px;padding:1px 5px;border-radius:10px;margin-left:4px;}
.tab.active .count{background:var(--accent);color:var(--bg);}
.list{padding:16px 20px;display:flex;flex-direction:column;gap:10px;}
.item-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden;display:flex;cursor:pointer;transition:border-color .2s;}
.item-card:hover{border-color:var(--accent);}
.item-photo{width:70px;min-height:70px;background:var(--surface2);display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;overflow:hidden;}
.item-photo img{width:100%;height:100%;object-fit:cover;}
.item-info{padding:10px 12px;flex:1;min-width:0;}
.item-name{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px;}
.item-meta{font-size:11px;color:var(--text2);margin-bottom:6px;}
.item-prices{display:flex;gap:12px;font-family:'Space Mono',monospace;font-size:11px;flex-wrap:wrap;}
.price-buy{color:var(--text2);}
.price-now{color:var(--accent2);font-weight:700;}
.price-diff{font-size:10px;padding:1px 5px;border-radius:4px;}
.price-diff.up{background:rgba(76,175,125,.15);color:var(--success);}
.price-diff.down{background:rgba(201,76,76,.15);color:var(--danger);}
.item-tag{font-size:10px;padding:2px 7px;border-radius:10px;border:1px solid var(--border);color:var(--text2);display:inline-block;margin-top:4px;}
.isbn-badge{display:inline-block;background:rgba(201,168,76,.1);border:1px solid var(--accent);color:var(--accent);font-family:'Space Mono',monospace;font-size:11px;padding:2px 7px;border-radius:6px;margin-top:4px;}
.empty{text-align:center;padding:60px 20px;color:var(--text2);}
.empty .icon{font-size:48px;margin-bottom:12px;}
.fab{position:fixed;bottom:24px;right:24px;width:56px;height:56px;border-radius:50%;background:var(--accent);color:var(--bg);border:none;font-size:28px;cursor:pointer;box-shadow:0 4px 20px rgba(201,168,76,.4);transition:transform .2s;z-index:200;display:flex;align-items:center;justify-content:center;}
.fab:hover{transform:scale(1.08);}
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:300;align-items:flex-end;}
.overlay.show{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:20px 20px 0 0;width:100%;max-height:92vh;overflow-y:auto;padding:24px 20px;animation:slideUp .3s ease;}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-title{font-size:18px;font-weight:900;color:var(--accent);margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;}
.close-btn{background:var(--surface2);border:1px solid var(--border);color:var(--text2);width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;}
.form-group{margin-bottom:16px;}
.form-label{display:block;font-size:11px;color:var(--text2);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;}
.form-input,.form-select,.form-textarea{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'Noto Serif TC',serif;font-size:14px;padding:10px 12px;transition:border-color .2s;outline:none;}
.form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--accent);}
.form-select option{background:var(--surface2);}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.isbn-row{display:flex;gap:8px;}
.isbn-row .form-input{flex:1;}
.scan-btn{flex-shrink:0;padding:10px 14px;background:var(--accent);color:var(--bg);border:none;border-radius:8px;font-size:15px;cursor:pointer;}
.scan-btn:hover{background:var(--accent2);}
.photo-upload{border:2px dashed var(--border);border-radius:10px;padding:20px;text-align:center;cursor:pointer;transition:border-color .2s;}
.photo-upload:hover{border-color:var(--accent);}
.photo-upload input{display:none;}
.photo-upload .icon{font-size:32px;margin-bottom:8px;}
.photo-upload p{font-size:12px;color:var(--text2);}
.photo-preview{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
.photo-thumb{width:60px;height:60px;border-radius:6px;object-fit:cover;border:1px solid var(--border);}
.photo-thumb-wrap{position:relative;display:inline-block;}
.photo-remove{position:absolute;top:-6px;right:-6px;width:18px;height:18px;background:var(--danger);border:none;border-radius:50%;color:white;font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.btn{padding:12px 20px;border-radius:8px;border:none;font-family:'Noto Serif TC',serif;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;width:100%;}
.btn-primary{background:var(--accent);color:var(--bg);}
.btn-primary:hover{background:var(--accent2);}
.btn-danger{background:rgba(201,76,76,.15);color:var(--danger);border:1px solid var(--danger);margin-top:8px;}
.btn-secondary{background:var(--surface2);color:var(--text);border:1px solid var(--border);margin-top:8px;}
.cat-list{display:flex;flex-direction:column;gap:8px;margin-bottom:16px;}
.cat-item{display:flex;align-items:center;justify-content:space-between;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 14px;}
.cat-name{font-size:14px;}
.cat-count{font-family:'Space Mono',monospace;font-size:11px;color:var(--text2);}
.cat-delete{background:none;border:none;color:var(--danger);cursor:pointer;font-size:16px;padding:4px;}
.detail-photo{width:100%;height:200px;background:var(--surface2);border-radius:10px;overflow:hidden;margin-bottom:16px;display:flex;align-items:center;justify-content:center;font-size:60px;}
.detail-photo img{width:100%;height:100%;object-fit:cover;}
.detail-photos-row{display:flex;gap:8px;margin-bottom:16px;overflow-x:auto;}
.detail-photos-row img{width:80px;height:80px;border-radius:8px;object-fit:cover;flex-shrink:0;border:2px solid transparent;cursor:pointer;}
.detail-photos-row img.active{border-color:var(--accent);}
.detail-field{margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid var(--border);}
.detail-field:last-of-type{border-bottom:none;}
.detail-field-label{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;}
.detail-field-value{font-size:15px;}
.detail-price-row{display:flex;gap:20px;background:var(--surface2);border-radius:10px;padding:14px;margin-bottom:16px;}
.detail-price-item{flex:1;}
.detail-price-item .label{font-size:10px;color:var(--text2);text-transform:uppercase;}
.detail-price-item .value{font-family:'Space Mono',monospace;font-size:16px;font-weight:700;color:var(--accent2);}
.search-bar{padding:12px 20px;border-bottom:1px solid var(--border);}
.search-input{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:20px;color:var(--text);font-family:'Noto Serif TC',serif;font-size:13px;padding:8px 16px;outline:none;transition:border-color .2s;}
.search-input:focus{border-color:var(--accent);}
.search-input::placeholder{color:var(--text2);}
#scannerOverlay{display:none;position:fixed;inset:0;background:#000;z-index:500;flex-direction:column;align-items:center;justify-content:center;}
#scannerOverlay.show{display:flex;}
#scanner-container{position:relative;width:100%;max-width:500px;}
#scanner-container video{width:100%;display:block;}
.scan-frame{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;}
.scan-frame-box{width:80%;height:120px;border:3px solid var(--accent);border-radius:8px;box-shadow:0 0 0 9999px rgba(0,0,0,.5);}
.scan-line{position:absolute;width:80%;height:2px;background:var(--accent);animation:scanLine 2s linear infinite;opacity:.8;}
@keyframes scanLine{0%{top:calc(50% - 60px)}100%{top:calc(50% + 60px)}}
.scan-status{color:var(--text);font-size:14px;margin-top:20px;text-align:center;padding:0 20px;}
.scan-close{position:absolute;top:20px;right:20px;background:rgba(0,0,0,.6);border:1px solid var(--border);color:var(--text);width:40px;height:40px;border-radius:50%;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.backup-list{display:flex;flex-direction:column;gap:8px;margin-bottom:16px;}
.backup-item{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 14px;display:flex;align-items:center;justify-content:space-between;gap:8px;}
.backup-item-date{font-family:'Space Mono',monospace;font-size:13px;}
.backup-item-meta{font-size:11px;color:var(--text2);margin-top:2px;}
.spinner{display:inline-block;width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;vertical-align:middle;margin-right:6px;}
@keyframes spin{to{transform:rotate(360deg)}}
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:var(--surface);border:1px solid var(--accent);color:var(--text);padding:10px 20px;border-radius:20px;font-size:13px;z-index:999;opacity:0;transition:opacity .3s;pointer-events:none;white-space:nowrap;}
.toast.show{opacity:1;}
.loading-screen{position:fixed;inset:0;background:var(--bg);z-index:999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;}
.loading-screen .icon{font-size:48px;}
.loading-screen p{color:var(--text2);font-size:14px;}
</style>
</head>
<body>

<div class="loading-screen" id="loadingScreen">
  <div class="icon">ğŸ“¦</div>
  <div class="spinner"></div>
  <p>é€£ç·šä¸­...</p>
</div>

<div class="header">
  <h1>è’è—ç®¡ç†</h1>
  <div class="header-right">
    <button class="backup-btn" onclick="openBackup()">ğŸ’¾ å‚™ä»½</button>
    <div class="sync-dot" id="syncDot"></div>
    <div class="header-stats">
      <div>ç¸½æ•¸ <span id="totalCount">0</span> ä»¶</div>
      <div>ç¾å€¼ <span id="totalValue">NT$0</span></div>
    </div>
  </div>
</div>

<div class="reminder-banner" id="reminderBanner">
  <p>ğŸ”” è·ä¸Šæ¬¡å‚™ä»½å·²è¶…éä¸€å€‹æœˆï¼Œå»ºè­°ç«‹å³ä¸‹è¼‰å‚™ä»½ã€‚</p>
  <button class="remind-btn" onclick="doBackupFromReminder()">ç«‹å³å‚™ä»½</button>
  <button class="dismiss-btn" onclick="dismissReminder()">ç¨å¾Œ</button>
</div>

<div class="summary" id="summaryBar"></div>
<div class="search-bar">
  <input class="search-input" placeholder="æœå°‹å“åæˆ–æè¿°..." id="searchInput" oninput="renderList()">
</div>
<div class="tabs" id="tabsBar"></div>
<div class="list" id="itemList"></div>
<button class="fab" onclick="openAdd()">ï¼‹</button>
<div class="toast" id="toast"></div>

<!-- Scanner -->
<div id="scannerOverlay">
  <button class="scan-close" onclick="closeScanner()">âœ•</button>
  <div id="scanner-container">
    <div id="interactive"></div>
    <div class="scan-frame"><div class="scan-frame-box"></div><div class="scan-line"></div></div>
  </div>
  <div class="scan-status" id="scanStatus">å°æº–æ›¸æœ¬èƒŒé¢çš„æ¢ç¢¼</div>
</div>

<!-- Add/Edit -->
<div class="overlay" id="addOverlay">
  <div class="modal">
    <div class="modal-title">
      <span id="modalTitle">æ–°å¢è’è—</span>
      <button class="close-btn" onclick="closeAdd()">âœ•</button>
    </div>
    <div class="form-group">
      <label class="form-label">å“å *</label>
      <input class="form-input" id="f_name" placeholder="è¼¸å…¥å“å">
    </div>
    <div class="form-group">
      <label class="form-label">åˆ†é¡ *</label>
      <div style="display:flex;gap:8px">
        <select class="form-select" id="f_cat" style="flex:1" onchange="toggleIsbn()"></select>
        <button class="btn btn-secondary" style="width:auto;padding:10px 14px;margin-top:0;font-size:12px" onclick="openCats()">ç®¡ç†åˆ†é¡</button>
      </div>
    </div>
    <div class="form-group" id="isbnGroup" style="display:none">
      <label class="form-label">ISBN</label>
      <div class="isbn-row">
        <input class="form-input" id="f_isbn" placeholder="æƒææˆ–æ‰‹å‹•è¼¸å…¥ ISBN">
        <button class="scan-btn" onclick="openScanner()">ğŸ“·</button>
      </div>
      <div id="isbnResult" style="margin-top:8px;font-size:12px;color:var(--text2)"></div>
    </div>
    <div class="form-group">
      <label class="form-label">æè¿° / å‚™è¨»</label>
      <textarea class="form-textarea" id="f_desc" rows="2" placeholder="ç‰ˆæœ¬ã€é™é‡ç·¨è™Ÿã€ç‰¹æ®Šèªªæ˜..."></textarea>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">è³¼è²·åƒ¹æ ¼ (NT$)</label>
        <input class="form-input" id="f_buyPrice" type="number" placeholder="0">
      </div>
      <div class="form-group">
        <label class="form-label">ç¾åœ¨å¸‚å€¼ (NT$)</label>
        <input class="form-input" id="f_nowPrice" type="number" placeholder="0">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">è³¼è²·æ—¥æœŸ</label>
        <input class="form-input" id="f_date" type="date">
      </div>
      <div class="form-group">
        <label class="form-label">è³¼è²·ä¾†æº</label>
        <input class="form-input" id="f_source" placeholder="æ›¸åº—ã€ä»£è³¼ã€æ‹è³£...">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">ç…§ç‰‡</label>
      <div class="photo-upload" onclick="document.getElementById('photoInput').click()">
        <input type="file" id="photoInput" accept="image/*" multiple onchange="handlePhotos(event)">
        <div class="icon">ğŸ“·</div>
        <p>é»æ“Šä¸Šå‚³ç…§ç‰‡ï¼ˆå¯å¤šå¼µï¼‰</p>
      </div>
      <div class="photo-preview" id="photoPreview"></div>
    </div>
    <button class="btn btn-primary" onclick="saveItem()">å„²å­˜</button>
    <button class="btn btn-danger" id="deleteBtn" style="display:none" onclick="deleteItem()">åˆªé™¤é€™ç­†è’è—</button>
  </div>
</div>

<!-- Categories -->
<div class="overlay" id="catOverlay">
  <div class="modal">
    <div class="modal-title">
      <span>ç®¡ç†åˆ†é¡</span>
      <button class="close-btn" onclick="closeCats()">âœ•</button>
    </div>
    <div class="cat-list" id="catList"></div>
    <div style="display:flex;gap:8px">
      <input class="form-input" id="newCatInput" placeholder="æ–°åˆ†é¡åç¨±" style="flex:1">
      <button class="btn btn-primary" style="width:auto;padding:10px 20px" onclick="addCategory()">æ–°å¢</button>
    </div>
  </div>
</div>

<!-- Detail -->
<div class="overlay" id="detailOverlay">
  <div class="modal">
    <div class="modal-title">
      <span>è’è—è©³æƒ…</span>
      <button class="close-btn" onclick="closeDetail()">âœ•</button>
    </div>
    <div id="detailContent"></div>
    <button class="btn btn-secondary" onclick="editCurrent()">âœï¸ ç·¨è¼¯</button>
  </div>
</div>

<!-- Backup -->
<div class="overlay" id="backupOverlay">
  <div class="modal">
    <div class="modal-title">
      <span>ğŸ’¾ å‚™ä»½ç®¡ç†</span>
      <button class="close-btn" onclick="closeBackup()">âœ•</button>
    </div>
    <div style="font-size:12px;color:var(--text2);margin-bottom:16px;background:var(--surface2);border-radius:8px;padding:10px 14px;line-height:1.7">
      ğŸ“Œ æ¯æœˆè‡ªå‹•æé†’å‚™ä»½ï¼Œæœ€å¤šä¿ç•™ <strong style="color:var(--accent)">5 ä»½</strong>ï¼Œè¶…éè‡ªå‹•ç§»é™¤æœ€èˆŠçš„ã€‚
    </div>
    <div class="backup-list" id="backupList"></div>
    <button class="btn btn-primary" onclick="createBackup()">â¬‡ï¸ ç«‹å³ä¸‹è¼‰å‚™ä»½</button>
    <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
      <label class="form-label">å¾å‚™ä»½é‚„åŸ</label>
      <input type="file" id="importInput" accept=".json" style="display:none" onchange="importBackup(event)">
      <button class="btn btn-secondary" style="margin-top:6px" onclick="document.getElementById('importInput').click()">ğŸ“‚ é¸æ“‡ JSON æª”æ¡ˆåŒ¯å…¥</button>
      <p style="font-size:11px;color:var(--danger);margin-top:8px">âš ï¸ åŒ¯å…¥å°‡è¦†è“‹ç›®å‰æ‰€æœ‰è³‡æ–™</p>
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyCjQ_gOIPqC4AK2mINm0SyCEwCiWQiQqYw",
  authDomain: "collection-tracker-9e54a.firebaseapp.com",
  projectId: "collection-tracker-9e54a",
  storageBucket: "collection-tracker-9e54a.firebasestorage.app",
  messagingSenderId: "134428450885",
  appId: "1:134428450885:web:c1f318314f975ba0db832c"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const BOOK_CATS=['æ›¸ç±','æ¼«ç•«','å°èªª','åŸæ–‡æ›¸'];
const DEFAULT_CATS=['æ›¸ç±','æ¼«ç•«','å°èªª','åŸæ–‡æ›¸','CD','æ¨¡å‹','äºŒå‰µ','å…¶ä»–'];
const MAX_BACKUPS=5, BACKUP_INTERVAL_MS=30*24*60*60*1000;
const DOC_ID='main'; // single document storing all data

let items=[], categories=[...DEFAULT_CATS];
let currentTab='all', editingId=null, currentPhotos=[], viewingId=null, scannerRunning=false;
let backupMeta=[];

// â”€â”€ Firebase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setSyncStatus(s){
  const d=document.getElementById('syncDot');
  d.className='sync-dot'+(s==='syncing'?' syncing':s==='error'?' error':'');
  d.title=s==='syncing'?'åŒæ­¥ä¸­...':s==='error'?'åŒæ­¥å¤±æ•—':'å·²åŒæ­¥';
}

async function cloudSave(){
  setSyncStatus('syncing');
  try{
    await setDoc(doc(db,'collection',DOC_ID),{items,categories,backupMeta,updatedAt:Date.now()});
    setSyncStatus('ok');
  }catch(e){
    console.error(e);
    setSyncStatus('error');
    showToast('âš ï¸ å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯');
  }
}

async function cloudLoad(){
  try{
    const snap=await getDoc(doc(db,'collection',DOC_ID));
    if(snap.exists()){
      const data=snap.data();
      items=data.items||[];
      categories=data.categories||[...DEFAULT_CATS];
      backupMeta=data.backupMeta||[];
    }
    setSyncStatus('ok');
  }catch(e){
    console.error(e);
    setSyncStatus('error');
    showToast('âš ï¸ è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯');
  }
}

// â”€â”€ Backup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkBackupReminder(){
  if(items.length===0) return;
  const banner=document.getElementById('reminderBanner');
  if(backupMeta.length===0){banner.style.display='flex';return;}
  const last=backupMeta[backupMeta.length-1];
  if(Date.now()-last.ts>=BACKUP_INTERVAL_MS) banner.style.display='flex';
}

function dismissReminder(){document.getElementById('reminderBanner').style.display='none';}
async function doBackupFromReminder(){dismissReminder();await createBackup();}

async function createBackup(){
  const now=new Date();
  const ymd=`${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
  const filename=`collection-backup-${ymd}.json`;
  const blob=new Blob([JSON.stringify({version:1,exportedAt:now.toISOString(),items,categories},null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download=filename;a.click();
  URL.revokeObjectURL(url);
  backupMeta.push({ts:Date.now(),filename,count:items.length});
  if(backupMeta.length>MAX_BACKUPS) backupMeta=backupMeta.slice(backupMeta.length-MAX_BACKUPS);
  await cloudSave();
  showToast('âœ… å‚™ä»½å·²ä¸‹è¼‰');
  renderBackupList();
}

function renderBackupList(){
  const el=document.getElementById('backupList');
  if(!backupMeta.length){el.innerHTML=`<div style="text-align:center;padding:20px;color:var(--text2);font-size:13px">å°šç„¡å‚™ä»½ç´€éŒ„</div>`;return;}
  el.innerHTML=[...backupMeta].reverse().map((m,i)=>{
    const d=new Date(m.ts);
    const ds=`${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;
    return `<div class="backup-item"><div><div class="backup-item-date">${i===0?'ğŸŸ¢ ':''}<span style="font-size:12px">${m.filename}</span></div><div class="backup-item-meta">${ds} Â· ${m.count} ä»¶</div></div></div>`;
  }).join('')+`<p style="font-size:11px;color:var(--text2);margin-top:4px">ä¿ç•™æœ€è¿‘ ${MAX_BACKUPS} ä»½</p>`;
}

async function importBackup(e){
  const file=e.target.files[0];if(!file)return;
  try{
    const data=JSON.parse(await file.text());
    if(!Array.isArray(data.items)) throw new Error();
    if(!confirm(`ç¢ºå®šå¾å‚™ä»½é‚„åŸï¼Ÿ\nç›®å‰ ${items.length} ç­† â†’ åŒ¯å…¥ ${data.items.length} ç­†\næ­¤æ“ä½œç„¡æ³•å¾©åŸ`)) return;
    items=data.items;
    if(data.categories) categories=data.categories;
    await cloudSave();renderAll();closeBackup();
    showToast(`âœ… å·²é‚„åŸ ${items.length} ç­†è’è—`);
  }catch(e){alert('åŒ¯å…¥å¤±æ•—ï¼šæ ¼å¼ä¸æ­£ç¢º');}
  e.target.value='';
}

function openBackup(){renderBackupList();document.getElementById('backupOverlay').classList.add('show');}
function closeBackup(){document.getElementById('backupOverlay').classList.remove('show');}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(n){if(!n&&n!==0)return'â€”';return'NT$'+Number(n).toLocaleString();}
function getCatEmoji(cat){return{'æ›¸ç±':'ğŸ“š','æ¼«ç•«':'ğŸ“–','å°èªª':'ğŸ“•','åŸæ–‡æ›¸':'ğŸŒ','CD':'ğŸ’¿','æ¨¡å‹':'ğŸ—¿','äºŒå‰µ':'ğŸ¨','å…¶ä»–':'ğŸ“¦'}[cat]||'ğŸ“¦';}
function isBookCat(cat){return BOOK_CATS.includes(cat);}
function toggleIsbn(){document.getElementById('isbnGroup').style.display=isBookCat(document.getElementById('f_cat').value)?'block':'none';}
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}
window.toggleIsbn=toggleIsbn;

// â”€â”€ ISBN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let isbnTimer;
async function lookupISBN(isbn){
  const el=document.getElementById('isbnResult');
  el.innerHTML='<span class="spinner"></span>æŸ¥è©¢ä¸­...';
  try{
    const r=await fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${isbn}&format=json&jscmd=data`);
    const data=await r.json();
    const book=data[`ISBN:${isbn}`];
    if(book){
      const title=book.title||'';
      const authors=(book.authors||[]).map(a=>a.name).join(', ');
      const pub=(book.publishers||[]).map(p=>p.name).join(', ');
      const year=book.publish_date||'';
      if(title&&!document.getElementById('f_name').value.trim()) document.getElementById('f_name').value=title;
      el.innerHTML=`<div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px;margin-top:4px">
        ${title?`<div style="font-weight:600;margin-bottom:4px">${title}</div>`:''}
        ${authors?`<div style="font-size:12px;color:var(--text2)">ä½œè€…ï¼š${authors}</div>`:''}
        ${pub?`<div style="font-size:12px;color:var(--text2)">å‡ºç‰ˆç¤¾ï¼š${pub}</div>`:''}
        ${year?`<div style="font-size:12px;color:var(--text2)">å‡ºç‰ˆå¹´ï¼š${year}</div>`:''}
      </div>`;
      showToast('âœ… æ›¸ç±è³‡è¨Šå·²è‡ªå‹•å¡«å…¥');
    }else{el.innerHTML='<span style="color:var(--text2);font-size:12px">æ‰¾ä¸åˆ°æ›¸ç±è³‡è¨Šï¼Œè«‹æ‰‹å‹•å¡«å¯«</span>';}
  }catch(e){el.innerHTML='<span style="color:var(--text2);font-size:12px">æŸ¥è©¢å¤±æ•—</span>';}
}

// â”€â”€ Scanner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openScanner(){document.getElementById('scannerOverlay').classList.add('show');document.getElementById('scanStatus').textContent='å°æº–æ›¸æœ¬èƒŒé¢çš„æ¢ç¢¼';startQuagga();}
function closeScanner(){stopQuagga();document.getElementById('scannerOverlay').classList.remove('show');}
function startQuagga(){
  if(scannerRunning)return;
  Quagga.init({inputStream:{name:'Live',type:'LiveStream',target:document.getElementById('interactive'),constraints:{facingMode:'environment',width:{ideal:1280},height:{ideal:720}}},decoder:{readers:['ean_reader','ean_8_reader','code_128_reader']},locate:true},err=>{
    if(err){document.getElementById('scanStatus').textContent='ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼Œè«‹ç¢ºèªå·²æˆäºˆæ¬Šé™';return;}
    Quagga.start();scannerRunning=true;
  });
  let last=null,cnt=0;
  Quagga.onDetected(r=>{
    const code=r.codeResult.code;
    if(code===last){cnt++;}else{last=code;cnt=1;}
    if(cnt>=3){
      document.getElementById('f_isbn').value=code;closeScanner();
      const c=code.replace(/[-\s]/g,'');
      if(c.length===10||c.length===13)lookupISBN(c);
      cnt=0;last=null;
    }else{document.getElementById('scanStatus').textContent='åµæ¸¬åˆ°æ¢ç¢¼ï¼Œè«‹ç¨å€™...';}
  });
}
function stopQuagga(){if(!scannerRunning)return;try{Quagga.stop();}catch(e){}scannerRunning=false;}
window.openScanner=openScanner;window.closeScanner=closeScanner;

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateSummary(){
  const tb=items.reduce((s,i)=>s+(Number(i.buyPrice)||0),0);
  const tn=items.reduce((s,i)=>s+(Number(i.nowPrice)||0),0);
  const diff=tn-tb;
  document.getElementById('totalCount').textContent=items.length;
  document.getElementById('totalValue').textContent=fmt(tn||tb);
  const cc={};items.forEach(i=>{cc[i.cat]=(cc[i.cat]||0)+1;});
  let html=`<div class="summary-item"><div class="label">è³¼å…¥</div><div class="value">${fmt(tb)}</div></div>
    <div class="summary-item"><div class="label">ç¾å€¼</div><div class="value">${fmt(tn)}</div></div>
    <div class="summary-item"><div class="label">å¢æ¸›</div><div class="value" style="color:${diff>=0?'var(--success)':'var(--danger)'}">${diff>=0?'+':''}${fmt(diff)}</div></div>`;
  Object.entries(cc).forEach(([c,n])=>{html+=`<div class="summary-item"><div class="label">${getCatEmoji(c)} ${c}</div><div class="value">${n}ä»¶</div></div>`;});
  document.getElementById('summaryBar').innerHTML=html;
}

function renderTabs(){
  const cc={};items.forEach(i=>{cc[i.cat]=(cc[i.cat]||0)+1;});
  let html=`<button class="tab ${currentTab==='all'?'active':''}" onclick="setTab('all')">å…¨éƒ¨ <span class="count">${items.length}</span></button>`;
  categories.forEach(c=>{html+=`<button class="tab ${currentTab===c?'active':''}" onclick="setTab('${c}')">${c} <span class="count">${cc[c]||0}</span></button>`;});
  document.getElementById('tabsBar').innerHTML=html;
}

function setTab(t){currentTab=t;renderTabs();renderList();}
window.setTab=setTab;

function renderList(){
  const s=document.getElementById('searchInput').value.toLowerCase();
  const filtered=items.filter(i=>{
    const mc=currentTab==='all'||i.cat===currentTab;
    const ms=!s||i.name.toLowerCase().includes(s)||(i.desc||'').toLowerCase().includes(s)||(i.isbn||'').includes(s);
    return mc&&ms;
  });
  if(!filtered.length){document.getElementById('itemList').innerHTML=`<div class="empty"><div class="icon">ğŸ“¦</div><p>æ²’æœ‰è’è—å“ï¼Œé»æ“Šä¸‹æ–¹ + æ–°å¢</p></div>`;return;}
  document.getElementById('itemList').innerHTML=filtered.map(item=>{
    const diff=(item.nowPrice&&item.buyPrice)?Number(item.nowPrice)-Number(item.buyPrice):null;
    const dh=diff!==null?`<span class="price-diff ${diff>=0?'up':'down'}">${diff>=0?'â–²':'â–¼'}${fmt(Math.abs(diff))}</span>`:'';
    const ph=item.photos?.length?`<img src="${item.photos[0]}" alt="">`:getCatEmoji(item.cat);
    return `<div class="item-card" onclick="openDetail('${item.id}')">
      <div class="item-photo">${ph}</div>
      <div class="item-info">
        <div class="item-name">${item.name}</div>
        <div class="item-meta">${item.cat}${item.source?' Â· '+item.source:''}${item.date?' Â· '+item.date:''}</div>
        <div class="item-prices">
          ${item.buyPrice?`<span class="price-buy">è²· ${fmt(item.buyPrice)}</span>`:''}
          ${item.nowPrice?`<span class="price-now">ç¾ ${fmt(item.nowPrice)}</span>`:''}
          ${dh}
        </div>
        ${item.isbn?`<span class="isbn-badge">ISBN ${item.isbn}</span>`:''}
        ${item.desc&&!item.isbn?`<div class="item-tag">${item.desc.slice(0,25)}${item.desc.length>25?'...':''}</div>`:''}
      </div>
    </div>`;
  }).join('');
}

function renderAll(){updateSummary();renderTabs();renderList();}
window.renderList=renderList;

// â”€â”€ Add/Edit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAdd(){
  editingId=null;currentPhotos=[];
  document.getElementById('modalTitle').textContent='æ–°å¢è’è—';
  document.getElementById('deleteBtn').style.display='none';
  ['f_name','f_desc','f_buyPrice','f_nowPrice','f_date','f_source','f_isbn'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('photoPreview').innerHTML='';
  document.getElementById('isbnResult').innerHTML='';
  populateCatSelect();toggleIsbn();
  document.getElementById('addOverlay').classList.add('show');
}
window.openAdd=openAdd;

function openEdit(id){
  const item=items.find(i=>i.id===id);if(!item)return;
  editingId=id;currentPhotos=item.photos?[...item.photos]:[];
  document.getElementById('modalTitle').textContent='ç·¨è¼¯è’è—';
  document.getElementById('deleteBtn').style.display='block';
  document.getElementById('f_name').value=item.name;
  document.getElementById('f_desc').value=item.desc||'';
  document.getElementById('f_buyPrice').value=item.buyPrice||'';
  document.getElementById('f_nowPrice').value=item.nowPrice||'';
  document.getElementById('f_date').value=item.date||'';
  document.getElementById('f_source').value=item.source||'';
  document.getElementById('f_isbn').value=item.isbn||'';
  document.getElementById('isbnResult').innerHTML='';
  populateCatSelect(item.cat);toggleIsbn();renderPhotoPreview();
  closeDetail();document.getElementById('addOverlay').classList.add('show');
}

function closeAdd(){document.getElementById('addOverlay').classList.remove('show');}
window.closeAdd=closeAdd;

function populateCatSelect(sel){
  document.getElementById('f_cat').innerHTML=categories.map(c=>`<option value="${c}" ${c===sel?'selected':''}>${getCatEmoji(c)} ${c}</option>`).join('');
  toggleIsbn();
}

function handlePhotos(e){
  Array.from(e.target.files).forEach(f=>{const r=new FileReader();r.onload=ev=>{currentPhotos.push(ev.target.result);renderPhotoPreview();};r.readAsDataURL(f);});
  e.target.value='';
}
window.handlePhotos=handlePhotos;

function renderPhotoPreview(){
  document.getElementById('photoPreview').innerHTML=currentPhotos.map((p,i)=>`<div class="photo-thumb-wrap"><img src="${p}" class="photo-thumb"><button class="photo-remove" onclick="removePhoto(${i})">âœ•</button></div>`).join('');
}
function removePhoto(i){currentPhotos.splice(i,1);renderPhotoPreview();}
window.removePhoto=removePhoto;

async function saveItem(){
  const name=document.getElementById('f_name').value.trim();
  if(!name){alert('è«‹è¼¸å…¥å“å');return;}
  const item={id:editingId||Date.now().toString(),name,cat:document.getElementById('f_cat').value,desc:document.getElementById('f_desc').value.trim(),buyPrice:document.getElementById('f_buyPrice').value,nowPrice:document.getElementById('f_nowPrice').value,date:document.getElementById('f_date').value,source:document.getElementById('f_source').value.trim(),isbn:document.getElementById('f_isbn').value.trim(),photos:[...currentPhotos]};
  if(editingId){const idx=items.findIndex(i=>i.id===editingId);items[idx]=item;}else{items.unshift(item);}
  closeAdd();renderAll();await cloudSave();showToast('âœ… å·²å„²å­˜');
}
window.saveItem=saveItem;

async function deleteItem(){
  if(!confirm('ç¢ºå®šè¦åˆªé™¤ï¼Ÿ'))return;
  items=items.filter(i=>i.id!==editingId);
  closeAdd();renderAll();await cloudSave();
}
window.deleteItem=deleteItem;

// â”€â”€ Categories â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openCats(){renderCatList();document.getElementById('catOverlay').classList.add('show');}
function closeCats(){document.getElementById('catOverlay').classList.remove('show');populateCatSelect(document.getElementById('f_cat').value);}
window.openCats=openCats;window.closeCats=closeCats;

function renderCatList(){
  const cc={};items.forEach(i=>{cc[i.cat]=(cc[i.cat]||0)+1;});
  document.getElementById('catList').innerHTML=categories.map(c=>`<div class="cat-item"><span class="cat-name">${getCatEmoji(c)} ${c}</span><span class="cat-count">${cc[c]||0} ä»¶</span><button class="cat-delete" onclick="deleteCategory('${c}')">âœ•</button></div>`).join('');
}

async function addCategory(){
  const name=document.getElementById('newCatInput').value.trim();if(!name)return;
  if(categories.includes(name)){alert('åˆ†é¡å·²å­˜åœ¨');return;}
  categories.push(name);document.getElementById('newCatInput').value='';
  renderCatList();await cloudSave();
}
window.addCategory=addCategory;

async function deleteCategory(name){
  if(items.some(i=>i.cat===name)){alert('æ­¤åˆ†é¡é‚„æœ‰è’è—å“ï¼Œç„¡æ³•åˆªé™¤');return;}
  categories=categories.filter(c=>c!==name);renderCatList();await cloudSave();
}
window.deleteCategory=deleteCategory;

// â”€â”€ Detail â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openDetail(id){
  viewingId=id;const item=items.find(i=>i.id===id);if(!item)return;
  const diff=(item.nowPrice&&item.buyPrice)?Number(item.nowPrice)-Number(item.buyPrice):null;
  let ph=item.photos?.length
    ?`<div class="detail-photo"><img src="${item.photos[0]}" id="mainPhotoImg"></div>`+(item.photos.length>1?`<div class="detail-photos-row">${item.photos.map((p,i)=>`<img src="${p}" class="${i===0?'active':''}" onclick="selectPhoto(${i},'${p}')">`).join('')}</div>`:'')
    :`<div class="detail-photo">${getCatEmoji(item.cat)}</div>`;
  document.getElementById('detailContent').innerHTML=`${ph}
    <h2 style="font-size:18px;margin-bottom:14px">${item.name}</h2>
    ${item.isbn?`<div style="margin-bottom:14px"><span class="isbn-badge">ğŸ“— ISBN ${item.isbn}</span></div>`:''}
    <div class="detail-price-row">
      <div class="detail-price-item"><div class="label">è³¼è²·åƒ¹æ ¼</div><div class="value">${fmt(item.buyPrice)}</div></div>
      <div class="detail-price-item"><div class="label">ç¾åœ¨å¸‚å€¼</div><div class="value">${fmt(item.nowPrice)}</div></div>
      ${diff!==null?`<div class="detail-price-item"><div class="label">å¢æ¸›</div><div class="value" style="color:${diff>=0?'var(--success)':'var(--danger)'}">${diff>=0?'+':''}${fmt(diff)}</div></div>`:''}
    </div>
    ${item.cat?`<div class="detail-field"><div class="detail-field-label">åˆ†é¡</div><div class="detail-field-value">${getCatEmoji(item.cat)} ${item.cat}</div></div>`:''}
    ${item.desc?`<div class="detail-field"><div class="detail-field-label">æè¿°</div><div class="detail-field-value">${item.desc}</div></div>`:''}
    ${item.date?`<div class="detail-field"><div class="detail-field-label">è³¼è²·æ—¥æœŸ</div><div class="detail-field-value">${item.date}</div></div>`:''}
    ${item.source?`<div class="detail-field"><div class="detail-field-label">è³¼è²·ä¾†æº</div><div class="detail-field-value">${item.source}</div></div>`:''}`;
  document.getElementById('detailOverlay').classList.add('show');
}
window.openDetail=openDetail;

function selectPhoto(i,src){document.getElementById('mainPhotoImg').src=src;document.querySelectorAll('.detail-photos-row img').forEach((el,idx)=>el.classList.toggle('active',idx===i));}
window.selectPhoto=selectPhoto;
function closeDetail(){document.getElementById('detailOverlay').classList.remove('show');}
window.closeDetail=closeDetail;
function editCurrent(){openEdit(viewingId);}
window.editCurrent=editCurrent;

// â”€â”€ Backup UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.openBackup=openBackup;window.closeBackup=closeBackup;
window.createBackup=createBackup;
window.doBackupFromReminder=doBackupFromReminder;
window.dismissReminder=dismissReminder;
window.importBackup=importBackup;

// â”€â”€ ISBN input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('f_isbn').addEventListener('input',e=>{
  clearTimeout(isbnTimer);
  const v=e.target.value.replace(/[-\s]/g,'');
  if(v.length===10||v.length===13)isbnTimer=setTimeout(()=>lookupISBN(v),600);
});

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
await cloudLoad();
document.getElementById('loadingScreen').style.display='none';
renderAll();
checkBackupReminder();

</script>
</body>
</html>
